<div class="threejs-box-wrapper">
    <!-- הודעת validation הוסרה - משתמשים ב-SnackBar -->
    
    <div class="main-flex-row">
        <div class="controls" [class.closed]="!drawerOpen">
            <button class="drawer-toggle" (click)="toggleDrawer()">
                <svg width="12" height="12" viewBox="0 0 12 12" style="display:block;margin:auto;">
                    <polyline points="4,2 8,6 4,10" stroke="#666" stroke-width="2" fill="none"
                        [attr.transform]="drawerOpen ? 'rotate(180 6 6)' : ''" />
                </svg>
            </button>
            <ng-container *ngIf="drawerOpen">
                <div *ngFor="let param of params" class="param-box">
                    <div *ngIf="param.name === 'shelfs'">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="shelf-row">
                            <mat-form-field appearance="outline">
                                <mat-label>סוג קורה</mat-label>
                                <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                    <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                        {{beam.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline">
                                <mat-label>סוג עץ</mat-label>
                                <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                    <mat-option
                                        *ngFor="let type of param.beams[param.selectedBeamIndex]?.types; let tIdx = index"
                                        [value]="tIdx">
                                        {{type.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="shelf-measurements-container">
                            <div *ngFor="let i of [].constructor(param.default.length); let idx = index" class="shelf-row">
                                <div class="shelf-gap-field-wrapper">
                                    <mat-form-field appearance="outline" class="shelf-gap-field">
                                        <mat-label>מידה {{param.default.length - idx}}</mat-label>
                                        <input matInput type="number" [min]="param.min" [max]="param.max" [step]="1"
                                            [(ngModel)]="param.default[param.default.length - 1 - idx]"
                                            (blur)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                                            (keyup.enter)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)">
                                    </mat-form-field>
                                    <button *ngIf="idx !== param.default.length - 1" class="remove-shelf-btn"
                                        (click)="param.default.splice(param.default.length - 1 - idx,1); updateBeams()"
                                        [disabled]="param.default.length<=1" aria-label="הסר מדף">
                                        <svg width="14" height="14" viewBox="0 0 14 14">
                                            <circle cx="7" cy="7" r="6" fill="#fff" stroke="#d32f2f" stroke-width="1.2" />
                                            <line x1="4.5" y1="4.5" x2="9.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                            <line x1="9.5" y1="4.5" x2="4.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="add-shelf-btn-container">
                                <button class="add-shelf-btn" (click)="param.default.push(param.min); updateBeams()">
                                    <svg viewBox="0 0 16 16" width="14" height="14">
                                        <circle cx="8" cy="8" r="7" fill="#fff" />
                                        <line x1="8" y1="4" x2="8" y2="12" stroke="#333" stroke-width="2" />
                                        <line x1="4" y1="8" x2="12" y2="8" stroke="#333" stroke-width="2" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="param.type === 'beamSingle'">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <mat-form-field appearance="outline">
                            <mat-label>סוג קורה</mat-label>
                            <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                    {{beam.translatedName}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                            <mat-label>סוג עץ</mat-label>
                            <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                <mat-option
                                    *ngFor="let type of param.beams[param.selectedBeamIndex]?.types; let tIdx = index"
                                    [value]="tIdx">
                                    {{type.translatedName}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                    <div *ngIf="param.type !== 'beamSingle' && param.name !== 'shelfs'">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="param-box non-beam">
                            <mat-form-field appearance="outline">
                                <mat-label>{{param.translatedName}}</mat-label>
                                <input matInput type="number" [min]="param.min" [max]="param.max"
                                    [step]="getStep(param.type)" [(ngModel)]="param.default" 
                                    (blur)="updateParameterValue(param, param.default)"
                                    (keyup.enter)="updateParameterValue(param, param.default)">
                            </mat-form-field>
                        </div>
                    </div>
                </div>
                <!-- טבלת מידות המוצר -->
                <div class="product-dimensions-container">
                    <h3>מידות המוצר הסופי</h3>
                    <table class="dimensions-table">
                        <tr>
                            <td>אורך כולל:</td>
                            <td [innerHTML]="getProductDimensions().length"></td>
                        </tr>
                        <tr>
                            <td>רוחב כולל:</td>
                            <td [innerHTML]="getProductDimensions().width"></td>
                        </tr>
                        <tr>
                            <td>גובה כולל:</td>
                            <td [innerHTML]="getProductDimensions().height"></td>
                        </tr>
                        <tr>
                            <td>כמות קורות במדף:</td>
                            <td [innerHTML]="getProductDimensions().beamCount"></td>
                        </tr>
                        <tr>
                            <td>רווח בין קורות המדף:</td>
                            <td [innerHTML]="getProductDimensions().gapBetweenBeams"></td>
                        </tr>
                        <tr>
                            <td>כמות מדפים:</td>
                            <td [innerHTML]="getProductDimensions().shelfCount"></td>
                        </tr>
                        <tr>
                            <td>גבהי המדפים:</td>
                            <td [innerHTML]="getProductDimensions().shelfHeights"></td>
                        </tr>
                    </table>
                </div>
            </ng-container>
        </div>
        <div #rendererContainer class="renderer-container" [class.expanded]="!drawerOpen"></div>
    </div>
</div>